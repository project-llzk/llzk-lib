// RUN: llzk-opt --convert-zklean-to-llzk %s 2>&1 | FileCheck --enable-var-scope %s

module @ZKLean attributes {llzk.lang = "llzk"} {
    ZKLeanLean.structure @IsZero {
        ZKLeanLean.member @out : !ZKExpr.zkexpr
        ZKLeanLean.member @inv : !ZKExpr.zkexpr
    }
    func.func @IsZero__constrain(%arg0: !ZKLeanLean.type<@IsZero>, %arg1: !felt.type) {
        %felt_const_0 = felt.const  0
        %0 = ZKExpr.Literal %felt_const_0
        %felt_const_1 = felt.const  1
        %1 = ZKExpr.Literal %felt_const_1
        %2 = ZKLeanLean.accessor %arg0[@out] : <@IsZero>, !ZKExpr.zkexpr
        %3 = ZKLeanLean.accessor %arg0[@inv] : <@IsZero>, !ZKExpr.zkexpr
        %4 = ZKExpr.Literal %arg1
        %5 = ZKExpr.Neg %4
        %6 = ZKExpr.Mul %5 %3
        %7 = ZKExpr.Add %6 %1
        %8 = ZKBuilder.ConstrainEq %2 %7
        %9 = ZKExpr.Mul %4 %2
        %10 = ZKBuilder.ConstrainEq %9 %0
        return
    }
}

// NOTE: Assertions have been autogenerated by scripts/generate-test-checks.py

// CHECK-LABEL: module @LLZK attributes {llzk.lang = "llzk"} {
// CHECK-NEXT:    struct.def @IsZero {
// CHECK-NEXT:      struct.member @out : !felt.type
// CHECK-NEXT:      struct.member @inv : !felt.type
// CHECK-NEXT:      function.def @compute(%[[VAL_0:[0-9a-zA-Z_\.]+]]: !felt.type) -> !struct.type<@IsZero> attributes {function.allow_witness} {
// CHECK-NEXT:        %[[VAL_1:[0-9a-zA-Z_\.]+]] = struct.new : <@IsZero>
// CHECK-NEXT:        function.return %[[VAL_1]] : !struct.type<@IsZero>
// CHECK-NEXT:      }
// CHECK-NEXT:      function.def @constrain(%[[VAL_2:[0-9a-zA-Z_\.]+]]: !struct.type<@IsZero>, %[[VAL_3:[0-9a-zA-Z_\.]+]]: !felt.type) attributes {function.allow_constraint} {
// CHECK-NEXT:        %[[VAL_4:[0-9a-zA-Z_\.]+]] = felt.const  0
// CHECK-NEXT:        %[[VAL_5:[0-9a-zA-Z_\.]+]] = felt.const  1
// CHECK-NEXT:        %[[VAL_6:[0-9a-zA-Z_\.]+]] = struct.readm %[[VAL_2]][@out] : <@IsZero>, !felt.type
// CHECK-NEXT:        %[[VAL_7:[0-9a-zA-Z_\.]+]] = struct.readm %[[VAL_2]][@inv] : <@IsZero>, !felt.type
// CHECK-NEXT:        %[[VAL_8:[0-9a-zA-Z_\.]+]] = felt.neg %[[VAL_3]] : !felt.type
// CHECK-NEXT:        %[[VAL_9:[0-9a-zA-Z_\.]+]] = felt.mul %[[VAL_8]], %[[VAL_7]] : !felt.type, !felt.type
// CHECK-NEXT:        %[[VAL_10:[0-9a-zA-Z_\.]+]] = felt.add %[[VAL_9]], %[[VAL_5]] : !felt.type, !felt.type
// CHECK-NEXT:        constrain.eq %[[VAL_6]], %[[VAL_10]] : !felt.type, !felt.type
// CHECK-NEXT:        %[[VAL_11:[0-9a-zA-Z_\.]+]] = felt.mul %[[VAL_3]], %[[VAL_6]] : !felt.type, !felt.type
// CHECK-NEXT:        constrain.eq %[[VAL_11]], %[[VAL_4]] : !felt.type, !felt.type
// CHECK-NEXT:        function.return
// CHECK-NEXT:      }
// CHECK-NEXT:    }
// CHECK-NEXT:  }